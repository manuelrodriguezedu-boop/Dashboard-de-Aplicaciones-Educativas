<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Resolviendo Reto - RazonaApp</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* ... (Your CSS is perfect and does not need changes) ... */
    :root {
      --primary: #007934; --secondary: #36933F; --light: #C9C9C9; --dark: #2E2725;
      --card-bg: #ffffff; --text-main: #2E2725; --text-light: #555559;
      --shadow: rgba(0, 0, 0, 0.08); --border-color: #e0e0e0;
    }
    body { background-color: var(--light); color: var(--text-main); line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; font-family: 'Segoe UI', sans-serif; }
    header { background: var(--primary); color: white; padding: 0.8rem 1.5rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; flex-wrap: wrap; }
    .logo { font-size: 1.6rem; font-weight: bold; display: flex; align-items: center; gap: 0.5rem; }
    .user-info { display: flex; align-items: center; gap: 1rem; }
    .back-btn { background: var(--secondary); color: white; text-decoration: none; padding: 0.4rem 0.8rem; border-radius: 5px; transition: background 0.3s; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 0.5rem; }
    .back-btn:hover { background: #1d5c2a; }
    main { max-width: 900px; margin: 2rem auto; padding: 0 1.5rem; flex-grow: 1; width: 100%; }
    .reto-header { background: var(--card-bg); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); margin-bottom: 2rem; }
    .reto-header h1 { color: var(--primary); margin-bottom: 0.5rem; }
    .reto-header p { color: var(--text-light); }
    .fase { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 12px var(--shadow); margin-bottom: 1.5rem; }
    .fase-header { background: var(--dark); color: white; padding: 1rem 1.5rem; border-radius: 12px 12px 0 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .fase-header h2 { font-size: 1.2rem; }
    .fase-content { padding: 1.5rem; border-top: 1px solid var(--border-color); display: none; }
    .fase-content.active { display: block; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; }
    textarea, select { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; font-family: 'Segoe UI', sans-serif; }
    textarea:focus, select:focus { outline: none; border-color: var(--secondary); }
    .actions { text-align: right; margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; flex-wrap: wrap; }
    .btn { padding: 0.8rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: background 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; }
    #save-progress-btn { background: var(--secondary); color: white; }
    #complete-btn { background: var(--primary); color: white; }
    .btn:hover { opacity: 0.9; }
    .btn-pdf { display: inline-flex; align-items: center; gap: 0.5rem; margin-top: 1rem; background-color: var(--primary); color: white; text-decoration: none; padding: 0.8rem 1.5rem; border-radius: 6px; font-weight: bold; transition: background-color 0.3s; }
    .btn-pdf:hover { background-color: #005a26; }
    footer { text-align: center; padding: 1.8rem 1rem; background: var(--dark); color: rgba(255, 255, 255, 0.7); margin-top: 2rem; font-size: 0.85rem; }
    footer p { margin: 0.2rem 0; }
  </style>
</head>
<body>

  <header>
    <div class="logo"><i class="fas fa-brain"></i> RazonaApp</div>
    <div class="user-info">
      <span id="user-name">Cargando...</span>
      <a href="../principal/dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i> Volver al Panel</a>
    </div>
  </header>

  <main>
    <div class="reto-header">
      <h1 id="reto-titulo">Cargando Reto...</h1>
      <p id="reto-descripcion">...</p>
      <a href="#" id="pdf-download-link" class="btn-pdf" style="display: none;">
        <i class="fas fa-file-pdf"></i> Descargar PDF Adjunto
      </a>
    </div>
    <!-- ... (El resto del HTML del formulario no cambia) ... -->
    <div class="fase"><div class="fase-header"><h2>1. Comprender el Problema</h2><i class="fas fa-chevron-down"></i></div><div class="fase-content active"><div class="form-group"><label for="f1-datos">¿Cuáles son los datos clave?</label><textarea id="f1-datos" rows="3"></textarea></div><div class="form-group"><label for="f1-objetivo">¿Cuál es la incógnita o el objetivo final?</label><textarea id="f1-objetivo" rows="2"></textarea></div></div></div>
    <div class="fase"><div class="fase-header"><h2>2. Diseñar un Plan</h2><i class="fas fa-chevron-down"></i></div><div class="fase-content"><div class="form-group"><label for="f2-estrategia">¿Qué estrategia/heurística usarás?</label><select id="f2-estrategia"><option value="">Selecciona una...</option><option value="analogia">Buscar analogías</option><option value="simplificar">Simplificar el problema</option><option value="dividir">Dividir y vencer</option><option value="experimentar">Experimentar (ensayo y error)</option><option value="atras">Trabajar hacia atrás</option></select></div><div class="form-group"><label for="f2-plan">Describe tu plan paso a paso</label><textarea id="f2-plan" rows="4"></textarea></div></div></div>
    <div class="fase"><div class="fase-header"><h2>3. Ejecutar el Plan</h2><i class="fas fa-chevron-down"></i></div><div class="fase-content"><div class="form-group"><label for="f3-ejecucion">Escribe aquí tu resolución (cálculos, diagramas, etc.)</label><textarea id="f3-ejecucion" rows="8"></textarea></div></div></div>
    <div class="fase"><div class="fase-header"><h2>4. Revisar y Reflexionar</h2><i class="fas fa-chevron-down"></i></div><div class="fase-content"><div class="form-group"><label for="f4-reflexion">¿La solución tiene sentido? ¿Qué has aprendido? ¿Podrías haberlo hecho de otra forma?</label><textarea id="f4-reflexion" rows="5"></textarea></div></div></div>
    <div class="actions"><button class="btn" id="save-progress-btn"><i class="fas fa-save"></i> Guardar Progreso</button><button class="btn" id="complete-btn"><i class="fas fa-check-circle"></i> Marcar como Completado</button></div>
  </main>
  
  <footer>
    <p>Manuel Rodríguez Peñalver</p>
    <p>Profesor de Tecnología, Coordinador TDE y Escuelas 4.0</p>
    <p>IES Sierra de los Filabres</p>
  </footer>

 <script>
    const SUPABASE_URL = 'https://usmzywbbyihphqateuxr.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzbXp5d2JieWlocGhxYXRldXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3ODY2MjMsImV4cCI6MjA3NTM2MjYyM30.Y3cKRrCBQ729ikGF8P2yOk2GS6QEd7Nud5nu8LDo98';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const userNameDisplay = document.getElementById('user-name');
    const retoTitulo = document.getElementById('reto-titulo');
    const retoDescripcion = document.getElementById('reto-descripcion');
    const pdfDownloadLink = document.getElementById('pdf-download-link');
    const saveButton = document.getElementById('save-progress-btn');
    const completeButton = document.getElementById('complete-btn');

    let currentUserId = null;
    let currentRetoId = null;

    async function loadPage() {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (!session) {
            window.location.href = '../auth/login.html';
            return;
        }
        currentUserId = session.user.id;
        userNameDisplay.textContent = session.user.email;

        const params = new URLSearchParams(window.location.search);
        currentRetoId = params.get('id');
        if (!currentRetoId) {
            alert("No se ha especificado un reto.");
            window.location.href = '../principal/dashboard.html';
            return;
        }

        const { data: retoData, error: retoError } = await supabaseClient
            .from('retos')
            .select('*, pdf_path')
            .eq('id', currentRetoId)
            .single();

        if (retoError) {
            console.error("Error cargando el reto:", retoError);
            return;
        }

        if (retoData) {
            retoTitulo.textContent = retoData.titulo;
            retoDescripcion.textContent = retoData.descripcion;
            const pdfPath = retoData.pdf_path;
            if (pdfPath) {
                const { data: urlData } = supabaseClient.storage.from('retos-pdf').getPublicUrl(pdfPath);
                if (urlData && urlData.publicUrl) {
                    pdfDownloadLink.href = urlData.publicUrl;
                    pdfDownloadLink.target = '_blank';
                    pdfDownloadLink.style.display = 'inline-flex';
                }
            }
        }
        
        const { data: resolucionData, error: resolucionError } = await supabaseClient
            .from('resoluciones')
            .select('*')
            .eq('id_alumno', currentUserId)
            .eq('id_reto', currentRetoId)
            .single();

        // --- CÓDIGO RESTAURADO ---
        if (resolucionData) {
            const resolucion = resolucionData;
            if (resolucion.fase1_comprension) {
                document.getElementById('f1-datos').value = resolucion.fase1_comprension.datos || '';
                document.getElementById('f1-objetivo').value = resolucion.fase1_comprension.objetivo || '';
            }
            if (resolucion.fase2_plan) {
                document.getElementById('f2-estrategia').value = resolucion.fase2_plan.estrategia || '';
                document.getElementById('f2-plan').value = resolucion.fase2_plan.plan || '';
            }
            document.getElementById('f3-ejecucion').value = resolucion.fase3_ejecucion || '';
            document.getElementById('f4-reflexion').value = resolucion.fase4_reflexion || '';
        }
    }

    // --- FUNCIÓN COMPLETADA ---
    async function saveOrUpdateResolution(estado = 'en_progreso') {
        const resolutionPayload = {
            id_alumno: currentUserId,
            id_reto: currentRetoId,
            fase1_comprension: {
                datos: document.getElementById('f1-datos').value,
                objetivo: document.getElementById('f1-objetivo').value,
            },
            fase2_plan: {
                estrategia: document.getElementById('f2-estrategia').value,
                plan: document.getElementById('f2-plan').value,
            },
            fase3_ejecucion: document.getElementById('f3-ejecucion').value,
            fase4_reflexion: document.getElementById('f4-reflexion').value,
            estado: estado,
            fecha_actualizacion: new Date().toISOString()
        };
        
        const { error } = await supabaseClient.from('resoluciones').upsert(resolutionPayload);

        if (error) {
            alert("Error al guardar: " + error.message);
        } else {
            if (estado === 'completado') {
                alert("¡Reto completado y enviado!");
                window.location.href = '../principal/dashboard.html';
            } else {
                alert("Progreso guardado con éxito.");
            }
        }
    }

    // Lógica para los acordeones
    document.querySelectorAll('.fase-header').forEach(header => {
        header.addEventListener('click', () => {
            const content = header.nextElementSibling;
            content.classList.toggle('active');
            header.querySelector('i').classList.toggle('fa-chevron-down');
            header.querySelector('i').classList.toggle('fa-chevron-up');
        });
    });
    
    // --- LISTENERS CORREGIDOS Y UNIFICADOS ---
    saveButton.addEventListener('click', async () => {
        saveButton.disabled = true;
        saveButton.innerHTML = 'Guardando...'; // innerHTML para que no se coma el icono
        await saveOrUpdateResolution('en_progreso');
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save"></i> Guardar Progreso';
    });

    completeButton.addEventListener('click', async () => {
        completeButton.disabled = true;
        completeButton.innerHTML = 'Enviando...';
        await saveOrUpdateResolution('completado');
        // No se reactiva porque la página redirige
    });

    document.addEventListener('DOMContentLoaded', loadPage);
  </script>

</body>
</html>
